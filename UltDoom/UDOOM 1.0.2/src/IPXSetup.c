// ipxsetup.c#define __MAC_VERSION__#include <GestaltEqu.h>#include <Lion.h>#include "LionDoom.h"#include "IPXNet.h" #include "DebugSwitches.h" #include "ipxcalls.h"#include "ipxerror.h"int			gameid;int			numnetnodes;extern short				gNumPlayersOnNet;extern int					gPlayersWanted;extern void 	SpinCursor (void);extern void LookForNodes (void);extern void IPXSetup (void);setupdata_t	nodesetup[MAXNETNODES];/*=============== NetISR==============*//*void interrupt NetISR (void){	if (doomcom->command == CMD_SEND)	{//I_ColorBlack (63,0,0);		gLocalTime++;		SendPacket (doomcom->remotenode);//I_ColorBlack (0,0,0);	}	else if (doomcom->command == CMD_GET)	{//I_ColorBlack (0,63,0);		GetPacket ();//I_ColorBlack (0,0,0);	}}*//*===================== LookForNodes== Finds all the nodes for the game and works out player numbers among them== Exits with nodesetup[0..numnodes] and nodeadr[0..numnodes] filled in===================*/void LookForNodes (void){	int             i,j,k;	int             netids[MAXNETNODES];	int             netplayer[MAXNETNODES];	long						time, oldsec;	setupdata_t			*setup, *dest;	int							total, console;	long						length;//// wait until we get [numnetnodes] packets, then start playing// the playernumbers are assigned by netid//#if __IPX_DEBUG__	fprintf(debugfile,"Attempting to find all players for %i player net play.Press ESC to exit.\n", numnetnodes);	fprintf(debugfile,"Looking for a node");#endif	oldsec = -1;	setup = (setupdata_t *)&doomcom->data;	gLocalTime = -1;		// in setup time, not game time//// build local setup info//	nodesetup[0].nodesfound = 1;	nodesetup[0].nodeswanted = numnetnodes;	doomcom->numnodes = 1;	do	{		if (CheckForTermination())		{			I_Error ("Network game synchronization aborted.");		}			SpinCursor();//// listen to the network//			while (GetPacket (&length))		{			SpinCursor();						if (CheckForTermination())			{				I_Error ("Network game synchronization aborted.");			}#if __IPX_DEBUG__			fprintf(debugfile,"Got an IPX packet");#endif			if (doomcom->remotenode == -1)			{				dest = &nodesetup[doomcom->numnodes];			}			else			{				dest = &nodesetup[doomcom->remotenode];			}						if (remotetime != -1)			{	// an early game packet, not a setup packet#if __IPX_DEBUG__				fprintf(debugfile,"remotetime != -1");#endif				if (doomcom->remotenode == -1)					I_Error ("Got an unknown game packet during setup");				// if it allready started, it must have found all nodes				dest->nodesfound = dest->nodeswanted;				continue;			}			// update setup ingo			memcpy (dest, setup, sizeof(*dest) );			if (doomcom->remotenode != -1)			{				continue;			// allready know that node address			}						//			// this is a new node			//#if __IPX_DEBUG__				fprintf(debugfile,"Got a new node");#endif			memcpy (&nodeadr[doomcom->numnodes], &remoteadr			, sizeof(nodeadr[doomcom->numnodes]) );			//			// if this node has a lower address, take all startup info			//			if ( memcmp (&remoteadr, &nodeadr[0], sizeof(&remoteadr) ) < 0 )			{			}			doomcom->numnodes++;/*			printf ("\nFound a node!\n");*//*			if (doomcom->numnodes < numnetnodes)				printf ("Looking for node");*/		}//// we are done if all nodes have found all other nodes//		SpinCursor();				for (i=0 ; i<doomcom->numnodes ; i++)		{			if (nodesetup[i].nodesfound != nodesetup[i].nodeswanted)			{				break;			}		}		if (i == nodesetup[0].nodeswanted)		{			break;		// got them all		}//// send out a broadcast packet every second//		time = TickCount ();		if (time <= oldsec + 60)			continue;		oldsec = time;/*		printf (".");*/		doomcom->datalength = sizeof(*setup);		nodesetup[0].nodesfound = doomcom->numnodes;		memcpy (&doomcom->data, &nodesetup[0], sizeof(setupdata_t));		gLocalTime = -2;		SendPacket (MAXNETNODES);	// send to all	} while (1);//// count players//	total = 0;	console = 0;	for (i=0 ; i<numnetnodes ; i++)	{		if (nodesetup[i].drone)			continue;		total++;		if (total > MAXPLAYERS)			I_Error ("More than %i players specified!",MAXPLAYERS);		if (memcmp (&nodeadr[i], &nodeadr[0], sizeof(nodeadr[0])) < 0)			console++;	}#if __IPX_DEBUG__				fprintf(debugfile,"got %d players", total);#endif	if (!total)		I_Error ("No players specified for game!");	doomcom->consoleplayer = console;	doomcom->numplayers = total;	gNumPlayersOnNet = total -1;	#if __IPX_DEBUG__				fprintf(debugfile,"Console is player %i of %i\n", console+1, total);#endif}/*=============== main==============*/void IPXSetup (void){	int	i;	long	ipxVers;//// determine game parameters//	if (Gestalt(gestaltNovellIPXVersion, &ipxVers))	{		I_Error("MacIPX is not installed.\nPlease install MacIPX and try again.");	}	else if (ipxVers == 0)	{		I_Error("The MacIPX driver is closed.\nPlease open the driver using the MacIPX Control Panel.");	}	netgame = true;	gameid = 0;	numnetnodes = gPlayersWanted;	doomcom->ticdup = 1;	doomcom->extratics = 1;	doomcom->episode = 1;	doomcom->map = 1;	doomcom->skill = 2;	doomcom->deathmatch = 0;/*	printf("\n"		   "--------------------------\n"		   "DOOM NETWORK DEVICE DRIVER\n"		   "--------------------------\n");	i = CheckParm ("-nodes");	if (i && i < _argc-1)	{		numnetnodes = atoi(_argv[i+1]);	}*/// make sure the network exists and create a bunch of buffers	IPXInitializeNet ();#if __IPX_DEBUG__	fprintf(debugfile,"Looking for nodes");#endif// get addresses of all nodes	if (gIPXNerd)	{/*		int			currTime, startTime;		Boolean nerdDone = false;		Boolean waitAgain;		int			length;				doomcom->numnodes = 2;		nodeadr[1].node = gIPXNerdAddr.node;				startTime = TickCount();		// Send out a message		while (TickCount() < startTime + (60 * 15) && !nerdDone)		{			doomcom->datalength = 8;			gLocalTime = -2;			SendPacket (1);	// send to other nerd					currTime = TickCount();			// Check for a message about every 1/2 seconds less than 10 times			while(TickCount() < currTime + (60 * 5) && !nerdDone)			{				Delay(30);				if (GetPacket(&length))				{					if (doomcom->remotenode == 1)						nerdDone = true;				}							ParamText("\pUnable to contact the other player at the specified address.  Would you like to continue to wait?", "\p", "\p", "\p");				waitAgain = Alert(rAlertGeneralYN, NULL);										BlackScreen();					if (waitAgain == kNoButton)				{					I_Exit();				}				else				{					startTime = TickCount();				}			}					}*/	}	else	{		LookForNodes ();	}		gLocalTime = 0;			// no longer in setup	doomcom->id = DOOMCOM_ID;}