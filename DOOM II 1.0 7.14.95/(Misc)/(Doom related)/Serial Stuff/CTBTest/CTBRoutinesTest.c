#include "CTBRoutines.h"#include <CTBUtilities.h>#include <CommResources.h>#include <Connections.h>#include <Stdio.h>#include <Traps.h>const 	Str32	kDefaultConnTool	= "\pApple Modem Tool";#define	kConnectionWaitTicks	-1 //(60 * 20)	//Time to wait when listening for connection request#define	kReadWaitTicks			(0)			//Time to wait when readingFILE		*tempfile;//_____________________________________________________________________//// ConfigConnection//// Configure Connection tool.//_____________________________________________________________________OSErr ConfigConnection(void){	short			procID;		// tool's ref number					Point			where;	CMBufferSizes	sizes;		// requested size of the buffers		Str255			toolName;	// tool file name			OSErr			status;		//	// Get ProcID	//			procID = -1;				// Unknown tool					// If it can't get the default, get the 1st		BlockMove(kDefaultConnTool, toolName, kDefaultConnTool[0] + 1);	procID = CMGetProcID(toolName);		if(procID == -1)	{		status = CRMGetIndToolName(classCM,1,toolName);		if (status == noErr)		{			procID = CMGetProcID(toolName);		}	}		if (procID == -1)	{		fprintf(tempfile,"No connection tools found\n");		status = cmNoTools;		goto ErrorDone;	}		//	// Create connection record - refCon and UserData are 0. 	//	sizes[cmDataIn] = kBufferSize;	sizes[cmDataOut] = kBufferSize;	sizes[cmCntlIn] = 0;	sizes[cmCntlOut] = 0;	sizes[cmAttnIn] = 0;	sizes[cmAttnOut] = 0;	gConn = CMNew(procID, cmData, sizes, 0, 0);	if (gConn == NULL)	{		fprintf(tempfile,"Can't create a connection tool\n");		goto ErrorDone;	}			MoveHHi((Handle) gConn);	HLock((Handle) gConn);		// Allocate space for the read/writes using the number		// returned by the connection tool						//본JDM if using an alternate buffer	gBuffer = NewPtr((*gConn)->bufSizes[cmDataIn]);	if ((status = MemError()) != noErr)	{		fprintf(tempfile,"Out of memory\n");		goto ErrorDone;	}	//	// Allow user to configure the tool using dialog box	//	if (gConn != NULL) 	{		HUnlock((Handle) gConn);				SetPt(&where,10,40);		status = CMChoose(&gConn, where, NULL);		switch (status) 		{			case chooseDisaster:			case chooseFailed:				fprintf(tempfile,"CMChoose failed\n");				goto ErrorDone;			break;			case chooseOKMajor: 			break;		}				HLock((Handle) gConn);	} 	ErrorDone:	return(status);}//_____________________________________________________________________//// InitializeComManagers//// Initialize the Communication Toolbox managers.////_____________________________________________________________________static OSErr InitializeComManagers(){	OSErr	status;		// Load up the Communications Toolbox			// Must Initialize CRM && CTBUtilities first		status = 	InitCRM();	if (status != cmNoErr)	{		fprintf(tempfile,"Error in calling InitCRM\n");		goto	ErrorDone;	}		status = 	InitCTBUtilities();	if (status != cmNoErr)	{		fprintf(tempfile,"Error in calling InitCTBUtilities\n");		goto	ErrorDone;	}	// initializes the Connection Manager 	status = 	InitCM();	if (status != cmNoErr)	{		if (status == cmNoTools)		{			fprintf(tempfile,"No Connection Manager tools were found\n");			goto	ErrorDone;		}		else		{			fprintf(tempfile,"Error in initializing Connection Manager\n");			goto	ErrorDone;		}	}	ErrorDone:		return(status);}//_____________________________________________________________________//	CTBOpenConnection	- Initiates a connection////_____________________________________________________________________Boolean CTBOpenConnection() {	CMBufferSizes	sizes;		// Connection Tool data			CMStatFlags		statusFlags;	CMErr			status;		if (gConn != NULL) 	{		// Get connection info				status = CMStatus(gConn, sizes, &statusFlags);				if (status == cmNoErr) 		{			// If it isn't already open, then open it				if ((statusFlags & (cmStatusOpen + cmStatusOpening)) == 0)			{				status = CMOpen(gConn, false, NULL, 0);			}			if (status != cmNoErr)			{				fprintf(tempfile,"Error calling CMOpen %hd\n",status );				return(false);			}		}	 	else	// CMStatus call failed	 	{			fprintf(tempfile,"Error calling CMStatus %hd, status %ld\n",status, statusFlags );			return(false);		}			}	return(true);}//_____________________________________________________________________////	CTBCloseConnection	- Kills a connection////_____________________________________________________________________void CTBCloseConnection(void) {	CMBufferSizes	sizes;		// Connection Tool data			CMStatFlags		statFlags;	OSErr			status;	// Kill the current connection		if (gConn != NULL) 	{		status = CMStatus(gConn, sizes, &statFlags);				// If it's open, then close it			if (status == noErr)		{			if ((statFlags & (cmStatusOpen + cmStatusOpening)) != 0)			{				status = CMClose(gConn, false, NULL, 0, true);			}		}					if (status != noErr)			;		// Conn tool will alert user on an error			}	}//_____________________________________________________________________//	CTBCloseAndDispose//// Closes connection and disposes of data structures////_____________________________________________________________________static void CloseAndDispose(void){		//본 JDM may want to kill io if asynch	CTBCloseConnection();			// Dispose of all the tools		if (gConn != NULL) 	{		HUnlock((Handle) gConn);		CMDispose(gConn);	}			//본JDM if using an alternate buffer/*	if (gBuffer != NULL)	// Clean up our buffer			{		DisposPtr(gBuffer);	}*/}	//_____________________________________________________________________////	CTBInitializeNet	- Initiates a connection////_____________________________________________________________________OSErr	CTBInitializeNet(){	OSErr	status;		gConn = NULL;	// Initialize CTB managers	if ((status = InitializeComManagers()) != noErr)	{		goto ErrorDone;	}		//	// Initialize the connection manager	//	if ((status = ConfigConnection()) != noErr)	{		goto ErrorDone;	}	// Open the connection//본JDM Need to call this explicitly ->	CTBOpenConnection();	ErrorDone:	return(status);}//_____________________________________________________________________////	CTBTerminateNet	- Terminates the connection and cleans up////_____________________________________________________________________OSErr CTBTerminateNet(){	CloseAndDispose();}OSErr CTBWaitForConnection(){	CMBufferSizes	sizes;		// Connection tool data			CMStatFlags		statFlags;	OSErr			status = noErr;		if (gConn == NULL)	{		fprintf(tempfile,"Cannot wait for connection because no tool has been initialized\n");		status = cmNoTools;		goto ErrorDone;	}		status = CMListen(gConn, false, NULL, kConnectionWaitTicks);	if (status != cmNoErr)	{		fprintf(tempfile,"Error in calling CMListen %hd\n",status);		status = 1;		goto ErrorDone;	}		status = 	CMStatus(gConn, sizes, &statFlags);	if (status != cmNoErr)	{		fprintf(tempfile,"Error in calling CMStatus %hd\n",status);		status = 1;		goto ErrorDone;	}		// Check if incoming call was received	if (!(statFlags & cmStatusIncomingCallPresent))	{		fprintf(tempfile,"No attempt to connect has been received\n");		status = 1;		goto ErrorDone;	}		//본퇽DM Should probably decide whether to accept instead of accepting blindly		// Connection request has been received, accept it	fprintf(tempfile,"Attempt to connect has been received\n");		status = CMAccept(gConn, true);	if (status != cmNoErr)	{		fprintf(tempfile,"Error in calling CMAccept %hd\n",status);		status = 1;		goto ErrorDone;	}ErrorDone:	return(status);	}OSErr CTBSendPacket(UInt16 sendTo, Ptr data, Size length){	CMFlags			cmFlags = 0;	long			bytesToWrite;	OSErr			status;		if (gConn == NULL)	{		fprintf(tempfile,"Cannot send data because no tool has been initialized\n");		status = cmNoTools;		goto ErrorDone;	}		bytesToWrite = length;		fprintf(tempfile,"About to write %hd chars\n", bytesToWrite);		status = CMWrite(gConn, data, &bytesToWrite, cmData, false, NULL, -1, cmFlags);	if (status != cmNoErr)	{		fprintf(tempfile,"Error in calling CMWrite %hd\n", status);		goto ErrorDone;	}	status = noErr;	// Write was successful	fprintf(tempfile,"Wrote %hd chars\n", bytesToWrite);	ErrorDone:	return(status);}Boolean CTBReceivePacket(Ptr data, Size *length){	CMFlags			cmFlags;	long			bytesToRead;	OSErr			status;		if (gConn == NULL)	{		fprintf(tempfile,"Cannot receive data because no tool has been initialized\n");		return(false);	}		bytesToRead = *length;		fprintf(tempfile,"Preparing to read\n");	status = CMRead(gConn, data, &bytesToRead, cmData, false, NULL, kReadWaitTicks, &cmFlags);	if (status != cmNoErr)	{		fprintf(tempfile,"Error in calling CMRead %hd\n", status);		*length = 0;		return(false);	}	else	{		fprintf(tempfile,"Read %hd bytes\n", bytesToRead);	}	// Read was successful		*length = bytesToRead;		return(true);}